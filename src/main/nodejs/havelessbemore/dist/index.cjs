/*!
 * https://github.com/havelessbemore/1brc-nodejs
 *
 * MIT License
 *
 * Copyright (C) 2024-2024 Michael Rojas <dev.michael.rojas@gmail.com> (https://github.com/havelessbemore)
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

"use strict";var V=require("node:os"),j=require("node:url"),D=require("node:worker_threads"),L=require("node:fs"),z=require("fs/promises"),J=require("worker_threads"),X=typeof document<"u"?document.currentScript:null;const U=1e4,Q=100,x=107,ee=16384,te=1048576,re=1048576,ne=152e-6,oe=16384,ae=1,se=512,ie=45,P=10,W=59,C=48,k=32,_e=216;function v(e,n,r){return e>n?e<=r?e:r:n}async function ce(e,n,r,l=0){const i=await z.open(e);try{const a=(await i.stat()).size,f=Math.max(l,Math.floor(a/n)),u=Buffer.allocUnsafe(r),o=[];let s=0;for(let c=f;c<a;c+=f){const I=await i.read(u,0,r,c),_=u.indexOf(P);_>=0&&_<I.bytesRead&&(c+=_+1,o.push([s,c]),s=c)}return s<a&&o.push([s,a]),o}finally{await i.close()}}function ue(e){return e*=ne,e=Math.round(Math.log2(e)),e=2**e,v(e,ee,te)}const Ee=655360,fe=1.6180339887,le=1,p=le,Ie=1,O=1,Re=1,H=Ie+Re,Me=0,Te=1,m=1,de=1,y=2,F=_e,B=p*F,S=Te+de+B,h=0,g=0,he=1,N=1,we=S,b=N+Me,q=he+we;function Ae(e,n,r,l){let i=N;for(;r<l;){i+=y+(n[r++]-k);let a=e[i];a===h&&(a=e[g],a+S>e.length&&(e=Z(e,a+S)),e[g]+=S,e[i]=a,e[a]=e[b]),i=a}return[e,i]}function K(e=0,n=Ee){n=Math.max(q,n);const r=new Int32Array(new SharedArrayBuffer(n<<2));return r[g]=q,r[b]=e,r}function Z(e,n=0){const r=e[g];n=Math.max(n,Math.ceil(r*fe));const l=new Int32Array(new SharedArrayBuffer(n<<2));for(let i=0;i<r;++i)l[i]=e[i];return l}function me(e,n,r,l){const i=new Set,a=[[n,N,r,N]];do{const f=a.length;for(let u=0;u<f;++u){let[o,s,c,I]=a[u];const _=e[c][I+m];if(_!==h){const R=e[o][s+m];R!==h?l(R,_):e[o][s+m]=_}s+=y,I+=y;const T=I+B;for(;I<T;){let R=e[c][I];if(R!==h){const w=e[c][R];c!==w&&(R=e[c][R+O]);let t=e[o][s];if(t===h)t=e[o][g],t+H>e[o].length&&(e[o]=Z(e[o],t+H),i.add(o)),e[o][g]+=H,e[o][s]=t,e[o][t]=w,e[o][t+O]=R;else{const E=e[o][t];o!==E&&(t=e[o][t+O]),a.push([E,t,w,R])}}s+=p,I+=p}}a.splice(0,f)}while(a.length>0);return Array.from(i)}function ge(e,n,r,l,i="",a){const f=new Array(n.length+1);f[0]=[r,N+y,0];let u=0,o=!1;do{let[s,c,I]=f[u];if(I>=F){--u;continue}f[u][1]+=p,++f[u][2];let _=e[s][c];if(_===h)continue;const T=e[s][_];s!==T&&(_=e[s][_+O],s=T),n[u]=I+k,f[++u]=[s,_+y,0];const R=e[s][_+m];R!==h&&(o&&l.write(i),o=!0,a(l,n,u,R))}while(u>=0)}function ye(e){const n=new J.Worker(e);return n.on("error",r=>{throw r}),n.on("messageerror",r=>{throw r}),n.on("exit",r=>{if(r>1||r<0)throw new Error(`Worker ${n.threadId} exited with code ${r}`)}),n}function G(e,n){return new Promise(r=>{e.once("message",r),e.postMessage(n)})}async function Ne(e,n,r,l=""){r=v(r,ae,se);const i=await ce(e,r,x,oe);r=i.length;const a=new SharedArrayBuffer(U*r+1<<4),f=new Int16Array(a),u=new Int16Array(a,2),o=new Uint32Array(a,4),s=new Float64Array(a,8),c=new Array(r),I=new Array(r);for(let t=0;t<r;++t)I[t]=ye(n);const _=new Array(r);for(let t=0;t<r;++t)_[t]=G(I[t],{type:"process",counts:o,end:i[t][1],filePath:e,id:t,maxes:u,mins:f,start:i[t][0],sums:s}).then(E=>{c[E.id]=E.trie});for(let t=_.length-1;t>0;--t){const E=t-1>>1,d=t;_[E]=_[E].then(()=>_[d]).then(()=>G(I[E],{type:"merge",a:E,b:d,counts:o,maxes:u,mins:f,sums:s,tries:c})).then(M=>{for(const A of M.ids)c[A]=M.tries[A]})}for(let t=0;t<r;++t)_[t]=_[t].then(()=>I[t].terminate());await Promise.all(_);const T=L.createWriteStream(l,{fd:l.length<1?1:void 0,flags:"a",highWaterMark:re}),R=Buffer.allocUnsafe(Q);T.write("{"),ge(c,R,0,T,", ",w),T.end(`}
`);function w(t,E,d,M){const A=Math.round(s[M<<1]/o[M<<2]);t.write(E.toString("utf8",0,d)),t.write("="),t.write((f[M<<3]/10).toFixed(1)),t.write("/"),t.write((A/10).toFixed(1)),t.write("/"),t.write((u[M<<3]/10).toFixed(1))}}const Y=11*C,$=111*C;function De(e,n,r){return e[n]===ie?(++n,n+4>r?-(10*e[n]+e[n+2]-Y):-(100*e[n]+10*e[n+1]+e[n+3]-$)):n+4>r?10*e[n]+e[n+2]-Y:100*e[n]+10*e[n+1]+e[n+3]-$}async function pe({end:e,filePath:n,id:r,start:l,counts:i,maxes:a,mins:f,sums:u}){if(l>=e)return{id:r,trie:K(r,0)};let o=K(r),s=r*U+1;const c=Buffer.allocUnsafe(x),I=L.createReadStream(n,{start:l,end:e-1,highWaterMark:ue(e-l)});let _=0,T;for await(const t of I){const E=t.length;for(let d=0;d<E;++d){if(t[d]!==P){c[_++]=t[d];continue}let M=_-4;c[M-2]===W?M-=2:c[M-1]===W&&(M-=1);const A=De(c,M+1,_);_=0,[o,T]=Ae(o,c,0,M),o[T+m]!==h?w(o[T+m],A):(o[T+m]=s,R(s++,A))}}function R(t,E){f[t<<3]=E,a[t<<3]=E,i[t<<2]=1,u[t<<1]=E}function w(t,E){t<<=3,f[t]=f[t]<=E?f[t]:E,a[t]=a[t]>=E?a[t]:E,++i[t>>1],u[t>>2]+=E}return{id:r,trie:o}}function Oe({a:e,b:n,tries:r,counts:l,maxes:i,mins:a,sums:f}){function u(o,s){o<<=3,s<<=3,a[o]=Math.min(a[o],a[s]),i[o]=Math.max(i[o],i[s]),l[o>>1]+=l[s>>1],f[o>>2]+=f[s>>2]}return{ids:me(r,e,n,u),tries:r}}if(D.isMainThread){const e=j.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:X&&X.src||new URL("index.cjs",document.baseURI).href);Ne(process.argv[2],e,V.availableParallelism())}else D.parentPort.addListener("message",async e=>{if(e.type==="process")D.parentPort.postMessage(await pe(e));else if(e.type==="merge")D.parentPort.postMessage(Oe(e));else throw new Error("Unknown message type")});
//# sourceMappingURL=index.cjs.map
