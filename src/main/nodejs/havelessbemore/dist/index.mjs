import{availableParallelism as G}from"node:os";import{fileURLToPath as V}from"node:url";import{isMainThread as K,parentPort as w}from"node:worker_threads";import{createWriteStream as x}from"node:fs";import{open as v}from"node:fs/promises";import{stdout as F}from"node:process";function y(e,t,r){return e>t?e<=r?e:r:t}async function b(e,t,r,a=0){let u=(await e.stat()).size,s=Math.max(a,Math.floor(u/t)),i=Buffer.allocUnsafe(r),f=[],n=0;for(let o=s;o<u;o+=s){let I=await e.read(i,0,r,o),l=i.indexOf(10);l>=0&&l<I.bytesRead&&(o+=l+1,f.push([n,o]),n=o)}return n<u&&f.push([n,u]),f}function L(e){return e*=.00625,e=Math.round(Math.log2(e)),e=2**e,y(e,16384,8388608)}function N(e,t,r,a){let u=1;for(;r<a;){u+=2+1*(t[r++]-32);let s=e[u+0];s===0&&(s=e[0],s+218>e.length&&(e=T(e,s+218)),e[0]+=218,e[u+0]=s,e[s+0]=e[1]),u=s}return[e,u]}function d(e=0,t=655360){t=Math.max(219,t);let r=new Int32Array(new SharedArrayBuffer(t<<2));return r[0]=219,r[1]=e,r}function T(e,t=0){let r=e[0];t=Math.max(t,Math.ceil(r*1.618033988749895));let a=new Int32Array(new SharedArrayBuffer(t<<2));for(let u=0;u<r;++u)a[u]=e[u];return a}function S(e,t,r,a){let u=[],s=[[t,1,r,1]];do{let i=s.length;for(let f=0;f<i;++f){let[n,o,I,l]=s[f],c=e[I][l+1];if(c!==0){let m=e[n][o+1];m!==0?a(m,c):e[n][o+1]=c}o+=2,l+=2;let M=l+216;for(;l<M;){let m=e[I][l+0];if(m!==0){let h=e[I][m+0];I!==h&&(m=e[I][m+1]);let D=e[n][o+0];if(D===0)D=e[n][0],D+2>e[n].length&&(e[n]=T(e[n],D+2),u.push(n)),e[n][0]+=2,e[n][o+0]=D,e[n][D+0]=h,e[n][D+1]=m;else{let R=e[n][D+0];n!==R&&(D=e[n][D+1]),s.push([R,D,h,m])}}o+=1,l+=1}}s.splice(0,i)}while(s.length>0);return u}function O(e,t,r,a,u="",s){let i=new Array(t.length+1);i[0]=[r,3,0];let f=0,n=!1;do{let[o,I,l]=i[f];if(l>=216){--f;continue}i[f][1]+=1,++i[f][2];let c=e[o][I+0];if(c===0)continue;let M=e[o][c+0];o!==M&&(c=e[o][c+1],o=M),t[f]=l+32,i[++f]=[o,c+2,0];let m=e[o][c+1];m!==0&&(n&&a.write(u),n=!0,s(a,t,f,m))}while(f>=0)}import{Worker as B}from"node:worker_threads";function U(e){let t=new B(e);return t.on("error",r=>{throw r}),t.on("messageerror",r=>{throw r}),t.on("exit",r=>{if(r>1||r<0)throw new Error(`Worker ${t.threadId} exited with code ${r}`)}),t}function g(e,t){return new Promise(r=>{e.once("message",r),e.postMessage(t)})}async function C(e,t,r,a=""){r=y(r,1,512);let u=await v(e,"r"),s=await b(u,r,107,16384);r=s.length;let i=new SharedArrayBuffer(1e4*r+1<<4),f=new Int16Array(i),n=new Int16Array(i,2),o=new Uint32Array(i,4),I=new Float64Array(i,8),l=new Array(r),c=[],M=new Array(r);for(let R=0;R<r;++R){let p=U(t);M[R]=g(p,{type:0,counts:o,end:s[R][1],filePath:e,id:R,maxes:n,mins:f,start:s[R][0],sums:I}).then(async _=>{let E=_.id;for(l[_.id]=_.trie;c.length>0;){let X=await g(p,{type:1,a:E,b:c.pop(),counts:o,maxes:n,mins:f,sums:I,tries:l});for(let A of X.ids)l[A]=X.tries[A]}return c.push(E),p.terminate()})}await Promise.all(M),await u.close();let m=x(a,{fd:a.length<1?F.fd:void 0,flags:"a",highWaterMark:1048576}),h=Buffer.allocUnsafe(100);m.write("{"),O(l,h,c[0],m,", ",D),m.end(`}
`);function D(R,p,_,E){let X=Math.round(I[E<<1]/o[E<<2]);R.write(p.toString("utf8",0,_)),R.write("="),R.write((f[E<<3]/10).toFixed(1)),R.write("/"),R.write((X/10).toFixed(1)),R.write("/"),R.write((n[E<<3]/10).toFixed(1))}}import{open as Z}from"fs/promises";var P=11*48,q=111*48;function H(e,t,r){return e[t]===45?(++t,t+4>r?P-10*e[t]-e[t+2]:q-100*e[t]-10*e[t+1]-e[t+3]):t+4>r?10*e[t]+e[t+2]-P:100*e[t]+10*e[t+1]+e[t+3]-q}async function W({end:e,filePath:t,id:r,start:a,counts:u,maxes:s,mins:i,sums:f}){if(a>=e)return{id:r,trie:d(r,0)};let n=d(r),o=r*1e4+1,I=await Z(t,"r"),l=L(e-a),c=Buffer.allocUnsafe(l+107),M=0,m=0,h;for(;a<e;){let p=await I.read(c,M,l,a);a+=p.bytesRead;for(let _=M+p.bytesRead;M<_;++M)if(c[M]===10){let E=M-5;c[E]!==59&&(E+=1|1+~(c[E-1]===59));let X=H(c,E+1,M);[n,h]=N(n,c,m,E),m=M+1,n[h+1]!==0?R(n[h+1],X):(n[h+1]=o,D(o++,X))}c.copyWithin(0,m,M),M-=m,m=0}function D(p,_){i[p<<3]=_,s[p<<3]=_,u[p<<2]=1,f[p<<1]=_}function R(p,_){p<<=3,i[p]=i[p]<=_?i[p]:_,s[p]=s[p]>=_?s[p]:_,++u[p>>1],f[p>>2]+=_}return await I.close(),{id:r,trie:n}}function k({a:e,b:t,tries:r,counts:a,maxes:u,mins:s,sums:i}){function f(o,I){o<<=3,I<<=3,s[o]=Math.min(s[o],s[I]),u[o]=Math.max(u[o],u[I]),a[o>>1]+=a[I>>1],i[o>>2]+=i[I>>2]}return{ids:S(r,e,t,f),tries:r}}if(K){let e=V(import.meta.url);C(process.argv[2],e,G())}else w.addListener("message",async e=>{if(e.type===0)w.postMessage(await W(e));else if(e.type===1)w.postMessage(k(e));else throw new Error("Unknown message type")});
//# sourceMappingURL=index.mjs.map
