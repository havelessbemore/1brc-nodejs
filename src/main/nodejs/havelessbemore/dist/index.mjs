import{availableParallelism as V}from"node:os";import{fileURLToPath as G}from"node:url";import{isMainThread as K,parentPort as b}from"node:worker_threads";import{createWriteStream as x}from"node:fs";import{open as Z}from"node:fs/promises";import{stdout as v}from"node:process";function d(e,t,r){return e>t?e<=r?e:r:t}async function w(e,t,r,I=0){let u=(await e.stat()).size,f=Math.max(I,Math.floor(u/t)),c=Buffer.allocUnsafe(r),a=[],n=0;for(let o=f;o<u;o+=f){let p=await e.read(c,0,r,o),m=c.indexOf(10);m>=0&&m<p.bytesRead&&(o+=m+1,a.push([n,o]),n=o)}return n<u&&a.push([n,u]),a}function L(e){return e*=152e-6,e=Math.round(Math.log2(e)),e=2**e,d(e,16384,1048576)}function N(e,t,r,I){let u=1;for(;r<I;){u+=2+1*(t[r++]-32);let f=e[u+0];f===0&&(f=e[0],f+218>e.length&&(e=T(e,f+218)),e[0]+=218,e[u+0]=f,e[f+0]=e[1]),u=f}return[e,u]}function g(e=0,t=655360){t=Math.max(219,t);let r=new Int32Array(new SharedArrayBuffer(t<<2));return r[0]=219,r[1]=e,r}function T(e,t=0){let r=e[0];t=Math.max(t,Math.ceil(r*1.618033988749895));let I=new Int32Array(new SharedArrayBuffer(t<<2));for(let u=0;u<r;++u)I[u]=e[u];return I}function S(e,t,r,I){let u=[],f=[[t,1,r,1]];do{let c=f.length;for(let a=0;a<c;++a){let[n,o,p,m]=f[a],l=e[p][m+1];if(l!==0){let R=e[n][o+1];R!==0?I(R,l):e[n][o+1]=l}o+=2,m+=2;let M=m+216;for(;m<M;){let R=e[p][m+0];if(R!==0){let h=e[p][R+0];p!==h&&(R=e[p][R+1]);let s=e[n][o+0];if(s===0)s=e[n][0],s+2>e[n].length&&(e[n]=T(e[n],s+2),u.push(n)),e[n][0]+=2,e[n][o+0]=s,e[n][s+0]=h,e[n][s+1]=R;else{let i=e[n][s+0];n!==i&&(s=e[n][s+1]),f.push([i,s,h,R])}}o+=1,m+=1}}f.splice(0,c)}while(f.length>0);return u}function O(e,t,r,I,u="",f){let c=new Array(t.length+1);c[0]=[r,3,0];let a=0,n=!1;do{let[o,p,m]=c[a];if(m>=216){--a;continue}c[a][1]+=1,++c[a][2];let l=e[o][p+0];if(l===0)continue;let M=e[o][l+0];o!==M&&(l=e[o][l+1],o=M),t[a]=m+32,c[++a]=[o,l+2,0];let R=e[o][l+1];R!==0&&(n&&I.write(u),n=!0,f(I,t,a,R))}while(a>=0)}import{Worker as W}from"node:worker_threads";function C(e){let t=new W(e);return t.on("error",r=>{throw r}),t.on("messageerror",r=>{throw r}),t.on("exit",r=>{if(r>1||r<0)throw new Error(`Worker ${t.threadId} exited with code ${r}`)}),t}function y(e,t){return new Promise(r=>{e.once("message",r),e.postMessage(t)})}async function U(e,t,r,I=""){r=d(r,1,512);let u=await Z(e,"r"),f=await w(u,r,107,16384);r=f.length;let c=new SharedArrayBuffer(1e4*r+1<<4),a=new Int16Array(c),n=new Int16Array(c,2),o=new Uint32Array(c,4),p=new Float64Array(c,8),m=new Array(r),l=[],M=new Array(r);for(let i=0;i<r;++i){let D=C(t);M[i]=y(D,{type:0,counts:o,end:f[i][1],fd:u.fd,id:i,maxes:n,mins:a,start:f[i][0],sums:p}).then(async _=>{let E=_.id;for(m[_.id]=_.trie;l.length>0;){let X=await y(D,{type:1,a:E,b:l.pop(),counts:o,maxes:n,mins:a,sums:p,tries:m});for(let A of X.ids)m[A]=X.tries[A]}return l.push(E),D.terminate()})}await Promise.all(M),await u.close();let R=x(I,{fd:I.length<1?v.fd:void 0,flags:"a",highWaterMark:1048576}),h=Buffer.allocUnsafe(100);R.write("{"),O(m,h,l[0],R,", ",s),R.end(`}
`);function s(i,D,_,E){let X=Math.round(p[E<<1]/o[E<<2]);i.write(D.toString("utf8",0,_)),i.write("="),i.write((a[E<<3]/10).toFixed(1)),i.write("/"),i.write((X/10).toFixed(1)),i.write("/"),i.write((n[E<<3]/10).toFixed(1))}}import{createReadStream as F}from"node:fs";var P=11*48,q=111*48;function H(e,t,r){return e[t]===45?(++t,t+4>r?P-10*e[t]-e[t+2]:q-100*e[t]-10*e[t+1]-e[t+3]):t+4>r?10*e[t]+e[t+2]-P:100*e[t]+10*e[t+1]+e[t+3]-q}async function k({end:e,fd:t,id:r,start:I,counts:u,maxes:f,mins:c,sums:a}){if(I>=e)return{id:r,trie:g(r,0)};let n=g(r),o=r*1e4+1,p=Buffer.allocUnsafe(107),m={autoClose:!1,fd:t,start:I,end:e-1,highWaterMark:L(e-I)},l=-1,M;for await(let s of F("",m)){let i=s.length;for(let D=0;D<i;++D)if(p[++l]=s[D],s[D]===10){let _=l-5;p[_]!==59&&(_+=1|1+~(p[_-1]===59));let E=H(p,_+1,l);l=-1,[n,M]=N(n,p,0,_),n[M+1]!==0?h(n[M+1],E):(n[M+1]=o,R(o++,E))}}function R(s,i){c[s<<3]=i,f[s<<3]=i,u[s<<2]=1,a[s<<1]=i}function h(s,i){s<<=3,c[s]=c[s]<=i?c[s]:i,f[s]=f[s]>=i?f[s]:i,++u[s>>1],a[s>>2]+=i}return{id:r,trie:n}}function B({a:e,b:t,tries:r,counts:I,maxes:u,mins:f,sums:c}){function a(o,p){o<<=3,p<<=3,f[o]=Math.min(f[o],f[p]),u[o]=Math.max(u[o],u[p]),I[o>>1]+=I[p>>1],c[o>>2]+=c[p>>2]}return{ids:S(r,e,t,a),tries:r}}if(K){let e=G(import.meta.url);U(process.argv[2],e,V())}else b.addListener("message",async e=>{if(e.type===0)b.postMessage(await k(e));else if(e.type===1)b.postMessage(B(e));else throw new Error("Unknown message type")});
//# sourceMappingURL=index.mjs.map
