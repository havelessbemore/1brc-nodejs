import{availableParallelism as J}from"node:os";import{fileURLToPath as z}from"node:url";import{isMainThread as ee,parentPort as L}from"node:worker_threads";import{closeSync as V,createWriteStream as G,fstatSync as Q,openSync as $}from"node:fs";import{stdout as j}from"node:process";function A(e,r,t){return e>r?e<=t?e:t:r}function S(e){return e*=.00625,e=Math.round(Math.log2(e)),e=2**e,A(e,16384,8388608)}function T(e,r){return Math.max(16384,Math.ceil(e/r))}function O(e,r,t){for(;--t>=0;)if(e[t]===r)return t;return-1}function U(e,r,t,a){let s=1;for(;t<a;){s+=2+1*(r[t++]-32);let I=e[s+0];I===0&&(I=e[0],I+218>e.length&&(e=P(e,I+218)),e[0]+=218,e[s+0]=I,e[I+0]=e[1]),s=I}return[e,s]}function C(e=0,r=655360){r=Math.max(219,r);let t=new Int32Array(new SharedArrayBuffer(r<<2));return t[0]=219,t[1]=e,t}function P(e,r=0){let t=e[0];r=Math.max(r,Math.ceil(t*1.618033988749895));let a=new Int32Array(new SharedArrayBuffer(r<<2));for(let s=0;s<t;++s)a[s]=e[s];return a}function q(e,r,t,a){let s=[],I=[[r,1,t,1]];do{let m=I.length;for(let i=0;i<m;++i){let[n,u,_,M]=I[i],p=e[_][M+1];if(p!==0){let c=e[n][u+1];c!==0?a(c,p):e[n][u+1]=p}u+=2,M+=2;let E=M+216;for(;M<E;){let c=e[_][M+0];if(c!==0){let o=e[_][c+0];_!==o&&(c=e[_][c+1]);let f=e[n][u+0];if(f===0)f=e[n][0],f+2>e[n].length&&(e[n]=P(e[n],f+2),s.push(n)),e[n][0]+=2,e[n][u+0]=f,e[n][f+0]=o,e[n][f+1]=c;else{let R=e[n][f+0];n!==R&&(f=e[n][f+1]),I.push([R,f,o,c])}}u+=1,M+=1}}I.splice(0,m)}while(I.length>0);return s}function B(e,r,t,a,s="",I){let m=new Array(r.length+1);m[0]=[t,3,0];let i=0,n=!1;do{let[u,_,M]=m[i];if(M>=216){--i;continue}m[i][1]+=1,++m[i][2];let p=e[u][_+0];if(p===0)continue;let E=e[u][p+0];u!==E&&(p=e[u][p+1],u=E),r[i]=M+32,m[++i]=[u,p+2,0];let c=e[u][p+1];c!==0&&(n&&a.write(s),n=!0,I(a,r,i,c))}while(i>=0)}import{Worker as Y}from"node:worker_threads";function H(e){let r=new Y(e);return r.on("error",t=>{throw t}),r.on("messageerror",t=>{throw t}),r.on("exit",t=>{if(t>1||t<0)throw new Error(`Worker ${r.threadId} exited with code ${t}`)}),r}function b(e,r){return new Promise(t=>{e.once("message",t),e.postMessage(r)})}async function Z(e,r,t,a=""){t=A(t,1,512);let s=$(e,"r"),m=Q(s).size,i=T(m,t),n=S(i),u=new SharedArrayBuffer(1e4*t+1<<4),_=new Uint32Array(u,0,1),M=new Int16Array(u),p=new Int16Array(u,2),E=new Uint32Array(u,4),c=new Float64Array(u,8),o=new Array(t),f=[],R=new Array(t);for(let l=0;l<t;++l){let D=H(r);R[l]=b(D,{type:0,id:l,fd:s,fileSize:m,pageSize:i,chunkSize:n,counts:E,maxes:p,mins:M,page:_,sums:c}).then(async h=>{let X=h.id;for(o[X]=h.trie;f.length>0;){let N=await b(D,{type:1,a:X,b:f.pop(),counts:E,maxes:p,mins:M,sums:c,tries:o});for(let w of N.ids)o[w]=N.tries[w]}return f.push(X),D.terminate()})}await Promise.all(R),V(s);let y=G(a,{fd:a.length<1?j.fd:void 0,flags:"a",highWaterMark:1048576}),d=Buffer.allocUnsafe(100);y.write("{"),B(o,d,f[0],y,", ",g),y.end(`}
`);function g(l,D,h,X){let N=Math.round(c[X<<1]/E[X<<2]);l.write(D.toString("utf8",0,h)),l.write("="),l.write((M[X<<3]/10).toFixed(1)),l.write("/"),l.write((N/10).toFixed(1)),l.write("/"),l.write((p[X<<3]/10).toFixed(1))}}import{readSync as v}from"fs";var k=11*48,W=111*48;function x(e,r,t){return e[r]===45?(++r,r+4>t?k-10*e[r]-e[r+2]:W-100*e[r]-10*e[r+1]-e[r+3]):r+4>t?10*e[r]+e[r+2]-k:100*e[r]+10*e[r+1]+e[r+3]-W}function F({id:e,fd:r,fileSize:t,pageSize:a,chunkSize:s,counts:I,maxes:m,mins:i,page:n,sums:u}){let _=(o,f)=>{i[o<<3]=f,m[o<<3]=f,I[o<<2]=1,u[o<<1]=f},M=(o,f)=>{o<<=3,i[o]=i[o]<=f?i[o]:f,m[o]=m[o]>=f?m[o]:f,++I[o>>1],u[o>>2]+=f},p=Buffer.allocUnsafe(s+107),E=e*1e4,c=C(e);for(;;){let o=a*Atomics.add(n,0,1);if(o>=t)break;let f=Math.min(t,o+a);o>0&&(o-=107,v(r,p,0,107,o),o+=1+O(p,10,107));for(let R=0;o<f;o+=s){let y=Math.min(s,f-o);y=R+v(r,p,R,y,o);let d=0;for(let g;R<y;++R){if(p[R]!==10)continue;let l=R-5;p[l]!==59&&(l+=1|1+~(p[l-1]===59)),[c,g]=U(c,p,d,l),d=R+1;let D=x(p,l+1,R);g+=1,c[g]!==0?M(c[g],D):(c[g]=++E,_(E,D))}p.copyWithin(0,d,R),R-=d}}return{id:e,trie:c}}function K({a:e,b:r,tries:t,counts:a,maxes:s,mins:I,sums:m}){return{ids:q(t,e,r,(n,u)=>{n<<=3,u<<=3,I[n]=I[n]<=I[u]?I[n]:I[u],s[n]=s[n]>=s[u]?s[n]:s[u],a[n>>1]+=a[u>>1],m[n>>2]+=m[u>>2]}),tries:t}}if(ee){let e=z(import.meta.url);Z(process.argv[2],e,J())}else L.addListener("message",e=>{if(e.type===0)L.postMessage(F(e));else if(e.type===1)L.postMessage(K(e));else throw new Error("Unknown message type")});
//# sourceMappingURL=index.mjs.map
