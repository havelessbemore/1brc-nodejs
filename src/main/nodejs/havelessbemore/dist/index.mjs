import{availableParallelism as J}from"node:os";import{fileURLToPath as z}from"node:url";import{isMainThread as ee,parentPort as L}from"node:worker_threads";import{closeSync as V,createWriteStream as G,fstatSync as Q,openSync as $}from"node:fs";import{stdout as j}from"node:process";function A(e,r,t){return e>r?e<=t?e:t:r}function S(e){return e*=.00625,e=Math.round(Math.log2(e)),e=2**e,A(e,16384,8388608)}function T(e,r){return Math.max(16384,Math.ceil(e/r))}function O(e,r,t){for(;--t>=0;)if(e[t]===r)return t;return-1}function U(e,r,t,a){let f=1;for(;t<a;){f+=2+1*(r[t++]-32);let I=e[f+0];I===0&&(I=e[0],I+218>e.length&&(e=P(e,I+218)),e[0]+=218,e[f+0]=I,e[I+0]=e[1]),f=I}return[e,f]}function C(e=0,r=655360){r=Math.max(219,r);let t=new Int32Array(new SharedArrayBuffer(r<<2));return t[0]=219,t[1]=e,t}function P(e,r=0){let t=e[0];r=Math.max(r,Math.ceil(t*1.618033988749895));let a=new Int32Array(new SharedArrayBuffer(r<<2));for(let f=0;f<t;++f)a[f]=e[f];return a}function q(e,r,t,a){let f=[],I=[[r,1,t,1]];do{let m=I.length;for(let i=0;i<m;++i){let[n,u,_,R]=I[i],p=e[_][R+1];if(p!==0){let c=e[n][u+1];c!==0?a(c,p):e[n][u+1]=p}u+=2,R+=2;let E=R+216;for(;R<E;){let c=e[_][R+0];if(c!==0){let o=e[_][c+0];_!==o&&(c=e[_][c+1]);let s=e[n][u+0];if(s===0)s=e[n][0],s+2>e[n].length&&(e[n]=P(e[n],s+2),f.push(n)),e[n][0]+=2,e[n][u+0]=s,e[n][s+0]=o,e[n][s+1]=c;else{let l=e[n][s+0];n!==l&&(s=e[n][s+1]),I.push([l,s,o,c])}}u+=1,R+=1}}I.splice(0,m)}while(I.length>0);return f}function B(e,r,t,a,f="",I){let m=new Array(r.length+1);m[0]=[t,3,0];let i=0,n=!1;do{let[u,_,R]=m[i];if(R>=216){--i;continue}m[i][1]+=1,++m[i][2];let p=e[u][_+0];if(p===0)continue;let E=e[u][p+0];u!==E&&(p=e[u][p+1],u=E),r[i]=R+32,m[++i]=[u,p+2,0];let c=e[u][p+1];c!==0&&(n&&a.write(f),n=!0,I(a,r,i,c))}while(i>=0)}import{Worker as Y}from"node:worker_threads";function H(e){let r=new Y(e);return r.on("error",t=>{throw t}),r.on("messageerror",t=>{throw t}),r.on("exit",t=>{if(t>1||t<0)throw new Error(`Worker ${r.threadId} exited with code ${t}`)}),r}function b(e,r){return new Promise(t=>{e.once("message",t),e.postMessage(r)})}async function k(e,r,t,a=""){t=A(t,1,512);let f=$(e,"r"),m=Q(f).size,i=T(m,t),n=S(i),u=new SharedArrayBuffer(1e4*t+1<<4),_=new Uint32Array(u,0,1),R=new Int16Array(u),p=new Int16Array(u,2),E=new Uint32Array(u,4),c=new Float64Array(u,8),o=new Array(t),s=[],l=new Array(t);for(let M=0;M<t;++M){let D=H(r);l[M]=b(D,{type:0,id:M,fd:f,fileSize:m,pageSize:i,chunkSize:n,counts:E,maxes:p,mins:R,page:_,sums:c}).then(async d=>{let y=d.id;for(o[y]=d.trie;s.length>0;){let N=await b(D,{type:1,a:y,b:s.pop(),counts:E,maxes:p,mins:R,sums:c,tries:o});for(let w of N.ids)o[w]=N.tries[w]}return s.push(y),D.terminate()})}await Promise.all(l),V(f);let X=G(a,{fd:a.length<1?j.fd:void 0,flags:"a",highWaterMark:1048576}),h=Buffer.allocUnsafe(100);X.write("{"),B(o,h,s[0],X,", ",g),X.end(`}
`);function g(M,D,d,y){let N=Math.round(c[y<<1]/E[y<<2]);M.write(D.toString("utf8",0,d)),M.write("="),M.write((R[y<<3]/10).toFixed(1)),M.write("/"),M.write((N/10).toFixed(1)),M.write("/"),M.write((p[y<<3]/10).toFixed(1))}}import{readSync as x}from"fs";var Z=11*48,W=111*48;function v(e,r,t){return e[r]===45?(++r,r+4>t?Z-10*e[r]-e[r+2]:W-100*e[r]-10*e[r+1]-e[r+3]):r+4>t?10*e[r]+e[r+2]-Z:100*e[r]+10*e[r+1]+e[r+3]-W}function F({id:e,fd:r,fileSize:t,pageSize:a,chunkSize:f,counts:I,maxes:m,mins:i,page:n,sums:u}){let _=(o,s)=>{i[o<<3]=s,m[o<<3]=s,I[o<<2]=1,u[o<<1]=s},R=(o,s)=>{o<<=3,i[o]=i[o]<=s?i[o]:s,m[o]=m[o]>=s?m[o]:s,++I[o>>1],u[o>>2]+=s},p=Buffer.allocUnsafe(f+107),E=e*1e4,c=C(e);for(;;){let o=a*Atomics.add(n,0,1);if(o>=t)break;let s=Math.min(t,o+a);o>0&&(o-=107,x(r,p,0,107,o),o+=1+O(p,10,107));let l=0,X=0,h=0;for(;o<s;){let g=Math.min(f,s-o);x(r,p,l,g,o),o+=g;for(let M=l+g;l<M;++l){if(p[l]!==10)continue;let D=l-5;p[D]!==59&&(D+=1|1+~(p[D-1]===59)),[c,X]=U(c,p,h,D),h=l+1;let d=v(p,D+1,l);X+=1,c[X]!==0?R(c[X],d):(c[X]=++E,_(E,d))}p.copyWithin(0,h,l),l-=h,h=0}}return{id:e,trie:c}}function K({a:e,b:r,tries:t,counts:a,maxes:f,mins:I,sums:m}){return{ids:q(t,e,r,(n,u)=>{n<<=3,u<<=3,I[n]=I[n]<=I[u]?I[n]:I[u],f[n]=f[n]>=f[u]?f[n]:f[u],a[n>>1]+=a[u>>1],m[n>>2]+=m[u>>2]}),tries:t}}if(ee){let e=z(import.meta.url);k(process.argv[2],e,J())}else L.addListener("message",e=>{if(e.type===0)L.postMessage(F(e));else if(e.type===1)L.postMessage(K(e));else throw new Error("Unknown message type")});
//# sourceMappingURL=index.mjs.map
